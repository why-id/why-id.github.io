<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WHO AM I</title>

<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Varela Round',Arial,sans-serif;
  background:linear-gradient(180deg,#f8fafc,#eef2f7);
}

.card{
  background:#fff;
  border-radius:18px;
  box-shadow:
    0 12px 30px rgba(0,0,0,.08),
    0 4px 10px rgba(0,0,0,.05);
}

/* LIKE ANIMATION */
.like-btn span{
  transition:transform .25s cubic-bezier(.34,1.56,.64,1),
             color .2s ease;
}
.like-btn.liked span{
  color:#ef4444;
  transform:scale(1.4) rotate(-8deg);
}
.like-btn.liked{
  animation:pop .35s ease-out;
}
@keyframes pop{
  0%{transform:scale(1)}
  50%{transform:scale(1.15)}
  100%{transform:scale(1)}
}
</style>
</head>

<body class="text-gray-900">

<!-- LOGIN -->
<div id="loginBox" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
  <div class="w-80 card p-6 space-y-4">
    <h2 class="text-xl font-bold text-center text-blue-500">Selamat Datang</h2>
    <input id="user" placeholder="Masukkan namamu"
      class="w-full border rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500">
    <button onclick="login()"
      class="w-full bg-blue-500 text-white py-3 rounded-xl font-semibold flex justify-center items-center gap-2">
      <span id="loginText">Masuk</span>
      <span id="loginLoad" class="hidden animate-spin material-icons-outlined">autorenew</span>
    </button>
  </div>
</div>

<!-- HEADER -->
<header class="sticky top-0 z-40 backdrop-blur bg-white/80 border-b">
  <div class="h-14 px-4 flex justify-between items-center max-w-xl mx-auto">
    <span class="material-icons-outlined">menu</span>
    <span class="font-bold text-blue-500 tracking-wide">WHO AM I</span>
    <button onclick="logout()" class="text-sm text-red-500">Keluar</button>
  </div>
</header>

<!-- COMPOSER -->
<div class="max-w-xl mx-auto px-3 py-4">
  <div class="card p-4">
    <textarea id="content" rows="3"
      placeholder="Apa yang sedang kamu pikirkan?"
      class="w-full resize-none text-sm outline-none"></textarea>
    <div class="flex justify-between items-center mt-3">
      <span class="text-xs text-gray-400 flex items-center gap-1">
        <span class="material-icons-outlined text-sm">public</span> Public
      </span>
      <button onclick="post()"
        class="bg-blue-500 text-white px-5 py-2 rounded-full text-sm font-semibold">
        Post
      </button>
    </div>
  </div>
</div>

<!-- FEED -->
<main id="feed" class="max-w-xl mx-auto px-3 space-y-4 pb-28"></main>

<!-- FLOAT -->
<button onclick="content.focus()"
  class="fixed bottom-20 right-5 w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-indigo-500 shadow-xl flex items-center justify-center">
  <span class="material-icons-outlined text-white text-2xl">edit</span>
</button>

<!-- BOTTOM NAV -->
<nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur border-t">
  <div class="max-w-xl mx-auto flex justify-around py-3 text-gray-500">
    <span class="material-icons-outlined text-blue-500">home</span>
    <span class="material-icons-outlined">search</span>
    <span class="material-icons-outlined">notifications_none</span>
    <span class="material-icons-outlined">mail_outline</span>
  </div>
</nav>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  query, orderBy, doc, setDoc, getDoc,
  updateDoc, deleteDoc,
  arrayUnion, arrayRemove, increment, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQ8JxN15lYecVlB7ewmH5CDJWT7H86kRI",
  authDomain: "whyid-5a5bc.firebaseapp.com",
  projectId: "whyid-5a5bc",
  storageBucket: "whyid-5a5bc.appspot.com",
  messagingSenderId: "379223608500",
  appId: "1:379223608500:web:ed1dfb3e7775766ecd1be1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = localStorage.getItem("user");
let userId = localStorage.getItem("uid");
const feed = document.getElementById("feed");

if(currentUser){
  loginBox.style.display="none";
  load();
}

window.login = async ()=>{
  const name = user.value.trim();
  if(!name) return alert("Nama wajib diisi");

  loginText.classList.add("hidden");
  loginLoad.classList.remove("hidden");

  const userRef = doc(db,"users",name.toLowerCase());
  const snap = await getDoc(userRef);
  if(snap.exists()){
    loginText.classList.remove("hidden");
    loginLoad.classList.add("hidden");
    return alert("Nama sudah dipakai");
  }

  await setDoc(userRef,{name,created:serverTimestamp()});
  currentUser=name;
  userId=name.toLowerCase();
  localStorage.setItem("user",currentUser);
  localStorage.setItem("uid",userId);
  loginBox.style.display="none";
  load();
};

window.logout = ()=>{
  localStorage.clear();
  location.reload();
};

function timeAgo(t){
  const s=Math.floor((Date.now()-t)/1000);
  if(s<60)return"Baru saja";
  const m=Math.floor(s/60);
  if(m<60)return m+" menit";
  const h=Math.floor(m/60);
  if(h<24)return h+" jam";
  return Math.floor(h/24)+" hari";
}

async function load(){
  feed.innerHTML="";
  const q=query(collection(db,"posts"),orderBy("time","desc"));
  const snap=await getDocs(q);

  snap.forEach(d=>{
    const p=d.data();
    const t=p.time?.toMillis?p.time.toMillis():Date.now();
    const liked=p.likedBy?.includes(userId);

    feed.innerHTML+=`
<div class="card p-4">
  <div class="flex gap-3">
    <div class="w-11 h-11 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white">
      <span class="material-icons-outlined">person</span>
    </div>

    <div class="flex-1">
      <div class="flex justify-between">
        <div>
          <div class="font-semibold text-sm">${p.username}</div>
          <div class="text-xs text-gray-500">@${p.username} Â· ${timeAgo(t)}</div>
        </div>

        <div class="relative">
          <button onclick="this.nextElementSibling.classList.toggle('hidden')">
            <span class="material-icons-outlined text-gray-400">more_vert</span>
          </button>
          <div class="hidden absolute right-0 mt-2 w-40 bg-white rounded-xl shadow-lg overflow-hidden z-10">
            <button onclick="this.closest('.card').remove()"
              class="w-full px-4 py-2 text-sm hover:bg-gray-100">Sembunyikan</button>
            ${p.uid===userId?`
            <button onclick="deletePost('${d.id}')"
              class="w-full px-4 py-2 text-sm text-red-500 hover:bg-red-50">Hapus</button>`:""}
          </div>
        </div>
      </div>

      <div class="mt-2 text-sm leading-relaxed break-words">${p.content}</div>

      <button onclick="like('${d.id}',${liked},this)"
        class="like-btn ${liked?'liked':''} flex items-center gap-1 mt-4 text-sm">
        <span class="material-icons-outlined text-base">
          ${liked?'favorite':'favorite_border'}
        </span>
        ${p.likes||0}
      </button>
    </div>
  </div>
</div>`;
  });
}

window.post = async ()=>{
  if(!content.value.trim()) return;
  await addDoc(collection(db,"posts"),{
    uid:userId,
    username:currentUser,
    content:content.value,
    likes:0,
    likedBy:[],
    time:serverTimestamp()
  });
  content.value="";
  load();
};

window.like = async(id,liked,btn)=>{
  btn.classList.toggle("liked");
  const ref=doc(db,"posts",id);
  await updateDoc(ref,{
    likes:increment(liked?-1:1),
    likedBy:liked?arrayRemove(userId):arrayUnion(userId)
  });
  load();
};

window.deletePost = async(id)=>{
  if(confirm("Hapus postingan ini?")){
    await deleteDoc(doc(db,"posts",id));
    load();
  }
};
</script>
</body>
</html>
