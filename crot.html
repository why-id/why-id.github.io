<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CROT.COM</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
</head>

<body class="bg-gray-100 flex justify-center">

<!-- LOGIN -->
<div id="loginBox" class="w-full max-w-md bg-white min-h-screen p-6 flex flex-col gap-4">
  <h1 class="text-3xl font-bold text-blue-600 text-center">CROT.COM</h1>

  <input id="username" placeholder="Nama Pengguna"
    class="border px-4 py-3 rounded-xl">

  <input id="password" type="password" placeholder="Password"
    class="border px-4 py-3 rounded-xl">

  <button onclick="login()"
    class="bg-blue-600 text-white py-3 rounded-xl">Masuk</button>

  <button onclick="register()"
    class="border py-3 rounded-xl">Daftar</button>

  <p id="msg" class="text-center text-red-500 text-sm"></p>
</div>

<!-- APP -->
<div id="app" class="hidden w-full max-w-md bg-white min-h-screen flex flex-col">

  <div class="px-4 py-4 border-b flex justify-between items-center">
    <div id="userLabel" class="font-semibold"></div>
    <button onclick="logout()" class="text-red-500 text-sm">Logout</button>
  </div>

  <div class="px-4 py-4 border-b space-y-3">
    <textarea id="content" rows="3"
      placeholder="Apa yang sedang Anda pikirkan..."
      class="w-full border rounded-xl px-3 py-3"></textarea>

    <button onclick="post()"
      class="bg-blue-600 text-white px-5 py-2 rounded-full">Post</button>
  </div>

  <div id="feed" class="flex-1"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, query,
  orderBy, serverTimestamp, updateDoc, doc,
  arrayUnion, arrayRemove, increment
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQ8JxN15lYecVlB7ewmH5CDJWT7H86kRI",
  authDomain: "whyid-5a5bc.firebaseapp.com",
  projectId: "whyid-5a5bc",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = localStorage.getItem("user");

const loginBox = document.getElementById("loginBox");
const appBox = document.getElementById("app");
const feed = document.getElementById("feed");

if(currentUser){
  loginBox.classList.add("hidden");
  appBox.classList.remove("hidden");
  userLabel.textContent = "@" + currentUser;
  load();
}

window.register = async () => {
  const u = username.value.trim();
  const p = password.value.trim();
  if(!u || !p) return msg.textContent = "Isi semua field";

  const snap = await getDocs(collection(db,"users"));
  if(snap.docs.some(d=>d.data().username===u))
    return msg.textContent="Username sudah ada";

  await addDoc(collection(db,"users"),{username:u,password:p});
  msg.textContent="Daftar berhasil, silakan masuk";
};

window.login = async () => {
  const u = username.value.trim();
  const p = password.value.trim();
  const snap = await getDocs(collection(db,"users"));

  const user = snap.docs.find(d=>d.data().username===u && d.data().password===p);
  if(!user) return msg.textContent="Login gagal";

  localStorage.setItem("user",u);
  location.reload();
};

window.logout = ()=>{
  localStorage.removeItem("user");
  location.reload();
};

async function load(){
  feed.innerHTML="";
  const q=query(collection(db,"posts"),orderBy("time","desc"));
  const snap=await getDocs(q);

  snap.forEach(d=>{
    const p=d.data();
    const liked=p.likedBy?.includes(currentUser);
    feed.innerHTML+=`
      <div class="px-4 py-4 border-b">
        <div class="font-semibold">@${p.username}</div>
        <div class="text-sm">${p.content}</div>
        <button onclick="likePost('${d.id}',${liked})"
          class="flex gap-1 text-sm ${liked?'text-red-500':''}">
          <span class="material-icons-outlined">
            ${liked?'favorite':'favorite_border'}
          </span>${p.likes||0}
        </button>
      </div>`;
  });
}

window.post=async()=>{
  if(!content.value.trim())return;
  await addDoc(collection(db,"posts"),{
    username:currentUser,
    content:content.value,
    likes:0,
    likedBy:[],
    time:serverTimestamp()
  });
  content.value="";
  load();
};

window.likePost=async(id,liked)=>{
  const ref=doc(db,"posts",id);
  await updateDoc(ref,liked?
    {likes:increment(-1),likedBy:arrayRemove(currentUser)}:
    {likes:increment(1),likedBy:arrayUnion(currentUser)}
  );
  load();
};
</script>

</body>
</html>
